{
    auto_https off
}

# Main client application on port 3000
:3000 {
    # LiveStore devtools endpoint
    handle /_livestore* {
        reverse_proxy client:5173 {
            header_up Host {host}
            header_up X-Real-IP {remote}
            header_up X-Forwarded-For {remote}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # Vite HMR and dev server assets
    handle /@vite/* {
        reverse_proxy client:5173 {
            header_up Host {host}
            header_up X-Real-IP {remote}
            header_up X-Forwarded-For {remote}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # Node modules and static assets
    handle /node_modules/* {
        reverse_proxy client:5173 {
            header_up Host {host}
            header_up X-Real-IP {remote}
            header_up X-Forwarded-For {remote}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # Source files
    handle /src/* {
        reverse_proxy client:5173 {
            header_up Host {host}
            header_up X-Real-IP {remote}
            header_up X-Forwarded-For {remote}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # API proxy for client
    handle /api/* {
        reverse_proxy fastapi:8000 {
            header_up Host {host}
            header_up X-Real-IP {remote}
            header_up X-Forwarded-For {remote}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # WebSocket proxy for LiveStore sync
    handle /websocket* {
        reverse_proxy fastapi:8000
    }

    # Proxy to client frontend (catch-all, must be last)
    handle {
        reverse_proxy client:5173 {
            header_up Host {host}
            header_up X-Real-IP {remote}
            header_up X-Forwarded-For {remote}
            header_up X-Forwarded-Proto {scheme}
        }
    }
}

# Admin client application on port 3001
:3001 {
    # Vite HMR and dev server assets
    handle /@vite/* {
        reverse_proxy admin-client:5173 {
            header_up Host {host}
            header_up X-Real-IP {remote}
            header_up X-Forwarded-For {remote}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # Node modules and static assets
    handle /node_modules/* {
        reverse_proxy admin-client:5173 {
            header_up Host {host}
            header_up X-Real-IP {remote}
            header_up X-Forwarded-For {remote}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # Source files
    handle /src/* {
        reverse_proxy admin-client:5173 {
            header_up Host {host}
            header_up X-Real-IP {remote}
            header_up X-Forwarded-For {remote}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # API proxy for admin client
    handle /api/* {
        reverse_proxy fastapi:8000 {
            header_up Host {host}
            header_up X-Real-IP {remote}
            header_up X-Forwarded-For {remote}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # Proxy to admin frontend (catch-all, must be last)
    handle {
        reverse_proxy admin-client:5173 {
            header_up Host {host}
            header_up X-Real-IP {remote}
            header_up X-Forwarded-For {remote}
            header_up X-Forwarded-Proto {scheme}
        }
    }
}

# Direct API access on port 80
:80 {
    # Main API proxy
    handle /* {
        reverse_proxy fastapi:8000 {
            header_up Host {host}
            header_up X-Real-IP {remote}
            header_up X-Forwarded-For {remote}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # WebSocket proxy
    handle /websocket* {
        reverse_proxy fastapi:8000
    }
}